#!/bin/bash

# Этот скрипт синхронизирует локальную директорию проекта с удаленным сервером
# и затем собирает и развертывает Docker-контейнеры на сервере.
# ВАЖНО: Этот скрипт предполагает, что у вас настроен SSH-доступ к серверу по ключу.

# --- Конфигурация ---
# Путь к вашему проекту на удаленном сервере
REMOTE_PROJECT_PATH="/root/seller"
# --- Конец конфигурации ---

echo "--- Запуск развертывания ---"

# Загрузка переменных окружения из .env файла
if [ -f .env ]; then
  export $(cat .env | sed 's/#.*//g' | xargs)
fi

# Проверка наличия необходимых переменных
if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ]; then
  echo "Ошибка: Переменные окружения SSH_HOST и SSH_USER должны быть установлены."
  echo "Их можно задать в файле .env"
  exit 1
fi

# --- Шаг 1: Синхронизация файлов с сервером ---
echo "Синхронизация файлов проекта с сервером: $REMOTE_PROJECT_PATH"

# Используем rsync для эффективной передачи только измененных файлов.
# Доступ по SSH должен быть настроен по ключу.
rsync -avz --delete \
  --exclude ".git" \
  --exclude "node_modules" \
  --exclude "dist" \
  --exclude ".idea" \
  --exclude "*.md" \
  -e "ssh -o StrictHostKeyChecking=no" \
  ./ "$SSH_USER@$SSH_HOST:$REMOTE_PROJECT_PATH/"

if [ $? -ne 0 ]; then
    echo "Ошибка при синхронизации файлов с помощью rsync."
    exit 1
fi

echo "Файлы успешно синхронизированы."

# --- Шаг 2: Сборка и запуск на удаленном сервере ---
echo "Подключаемся к $SSH_HOST для сборки и запуска Docker-контейнеров..."

# Подключение к серверу по SSH и выполнение команд
ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
  set -e # Немедленно выходить, если команда завершается с ошибкой.

  echo '--- Развертывание на сервере ---'
  cd '$REMOTE_PROJECT_PATH'

  echo 'Собираем и развертываем Docker-контейнеры...'
  docker compose up --build -d

  echo '--- Развертывание завершено ---'
"

echo "Скрипт развертывания завершен."
